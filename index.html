<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å²ä¸¹ï¼æº«æ–¯å¦ (Stan Weinstein) æ——è‰¦æ“ç›¤ç³»çµ± v4.3</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .check-pass { color: #16a34a; }
        .check-fail { color: #dc2626; }
        .check-warn { color: #ca8a04; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-slate-900 text-white px-6 py-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center gap-3">
                <div class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white p-2 rounded-lg shadow-lg">
                    <i class="fa-solid fa-layer-group"></i>
                </div>
                <div class="flex flex-col">
                    <span>å²ä¸¹ï¼æº«æ–¯å¦ <span class="text-blue-400">æ——è‰¦æ“ç›¤ç³»çµ±</span></span>
                    <span class="text-[10px] text-slate-400 font-normal">v4.3 Pro (Radar Fixed + RS Lines Restored)</span>
                </div>
            </h1>
            <div class="hidden md:flex gap-3 text-xs">
                <button onclick="toggleScanner()" class="bg-indigo-600 hover:bg-indigo-700 px-3 py-1.5 rounded transition-colors flex items-center gap-2">
                    <i class="fa-solid fa-list-ol"></i> æ‰¹æ¬¡æƒææ¨¡å¼
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto p-4 md:p-6 flex-grow max-w-[1600px]">
        
        <!-- Controls Section -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-6">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-end">
                
                <!-- Stock Input -->
                <div class="lg:col-span-3">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">è‚¡ç¥¨ä»£ç¢¼ (Ticker)</label>
                    <div class="relative">
                        <input type="text" id="tickerInput" value="2330" class="w-full pl-4 pr-10 py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 focus:ring-0 outline-none uppercase font-mono text-lg font-bold placeholder-slate-300 transition-colors" placeholder="å¦‚ 2330 æˆ– NVDA">
                        <span class="absolute right-3 top-4 text-slate-400 text-xs font-bold">STOCK</span>
                    </div>
                </div>

                <!-- Index Input -->
                <div class="lg:col-span-3">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">å°æ¯”å¤§ç›¤ (Relative Strength)</label>
                    <div class="relative">
                        <select id="indexInput" class="w-full pl-4 pr-10 py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none appearance-none bg-white font-medium text-slate-700">
                            <option value="^TWII">å°ç£åŠ æ¬ŠæŒ‡æ•¸ (TWII)</option>
                            <option value="^GSPC">ç¾è‚¡ S&P 500</option>
                            <option value="^IXIC">ç¾è‚¡ Nasdaq</option>
                            <option value="^DJI">ç¾è‚¡ é“ç“Šå·¥æ¥­</option>
                        </select>
                        <i class="fa-solid fa-chevron-down absolute right-4 top-4 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>

                <!-- MA & Timeframe Settings -->
                <div class="lg:col-span-4 flex gap-2">
                    <!-- MA Type Selector -->
                    <div class="w-24">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">å‡ç·šç®—æ³•</label>
                        <select id="maType" class="w-full h-[50px] px-2 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none bg-white font-bold text-slate-600 text-xs" onchange="if(!document.getElementById('analyzeBtn').disabled && currentTicker) runAnalysis()">
                            <option value="WMA" selected>WMA (åŠ æ¬Š)</option>
                            <option value="SMA">SMA (ç°¡å–®)</option>
                        </select>
                    </div>
                    
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">å‡ç·šåƒæ•¸ (MA)</label>
                        <div class="flex bg-slate-100 p-1 rounded-xl h-[50px] items-center">
                            <button onclick="setMA(20)" id="ma-20" class="flex-1 h-full rounded-lg text-xs font-bold text-slate-500 hover:bg-white transition-all">20MA</button>
                            <button onclick="setMA(30)" id="ma-30" class="flex-1 h-full rounded-lg text-xs font-bold bg-white text-blue-600 shadow-sm border border-slate-200 transition-all">30MA</button>
                            <button onclick="setMA(60)" id="ma-60" class="flex-1 h-full rounded-lg text-xs font-bold text-slate-500 hover:bg-white transition-all">60MA</button>
                        </div>
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">åˆ†æé€±æœŸ</label>
                        <div class="flex bg-slate-100 p-1 rounded-xl h-[50px] items-center">
                            <button onclick="setTimeframe('D')" id="tf-D" class="flex-1 h-full rounded-lg text-xs font-bold text-slate-500 hover:bg-white transition-all">æ—¥ç·š</button>
                            <button onclick="setTimeframe('W')" id="tf-W" class="flex-1 h-full rounded-lg text-xs font-bold bg-white text-blue-600 shadow-sm border border-slate-200 transition-all">é€±ç·š</button>
                            <button onclick="setTimeframe('M')" id="tf-M" class="flex-1 h-full rounded-lg text-xs font-bold text-slate-500 hover:bg-white transition-all">æœˆç·š</button>
                        </div>
                    </div>
                </div>

                <!-- Action Button -->
                <div class="lg:col-span-2">
                    <button onclick="runAnalysis()" id="analyzeBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-all shadow-lg shadow-blue-200 flex justify-center items-center gap-2 transform active:scale-95 h-[50px]">
                        <i class="fa-solid fa-magnifying-glass-chart"></i>
                        <span>åˆ†æ</span>
                    </button>
                </div>
            </div>

            <!-- Messages -->
            <div id="fetchProgress" class="hidden mt-4 text-xs font-bold text-blue-600 animate-pulse">
                <i class="fa-solid fa-circle-notch fa-spin mr-2"></i> <span id="progressText">è³‡æ–™ä¸‹è¼‰ä¸­...</span>
            </div>
            <div id="errorMsg" class="hidden mt-4 p-3 bg-red-50 border border-red-100 text-red-600 rounded-lg text-sm flex items-center gap-2">
                <i class="fa-solid fa-circle-exclamation"></i> <span id="errorText"></span>
            </div>
            <div id="warnMsg" class="hidden mt-4 p-3 bg-yellow-50 border border-yellow-100 text-yellow-700 rounded-lg text-sm flex items-center gap-2">
                <i class="fa-solid fa-triangle-exclamation"></i> <span id="warnText"></span>
            </div>
        </div>

        <!-- Scanner / Batch Mode (Hidden by default) -->
        <div id="scannerPanel" class="hidden bg-white rounded-2xl shadow-sm border border-indigo-100 p-6 mb-6 fade-in relative overflow-hidden">
            <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
            <h3 class="font-bold text-lg text-indigo-900 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-list-ol"></i> è‡ªé¸è‚¡æ‰¹æ¬¡æƒæ (Batch Scanner)
            </h3>
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div class="lg:col-span-3">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æ¸…å–® (ä»¥é€—è™Ÿåˆ†éš”)</label>
                    <textarea id="batchInput" class="w-full p-4 border border-slate-200 rounded-xl focus:border-indigo-500 outline-none font-mono text-sm h-24" placeholder="ä¾‹å¦‚: 2330, 2317, 2454, NVDA, AAPL"></textarea>
                </div>
                <div class="flex flex-col justify-end">
                    <button onclick="runBatchAnalysis()" id="batchBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-200 transition-all">
                        <i class="fa-solid fa-play"></i> é–‹å§‹æƒææ’å
                    </button>
                </div>
            </div>
            <div id="batchResults" class="mt-6 hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-indigo-50 text-indigo-900 uppercase font-bold text-xs">
                            <tr>
                                <th class="px-4 py-3 rounded-l-lg">ä»£ç¢¼</th>
                                <th class="px-4 py-3">ç¾åƒ¹</th>
                                <th class="px-4 py-3">å‡ç·šç‹€æ…‹</th>
                                <th class="px-4 py-3">Mansfield RS</th>
                                <th class="px-4 py-3">å¤šæ–¹ç¸½åˆ†</th>
                                <th class="px-4 py-3 rounded-r-lg">è©•ç´š</th>
                            </tr>
                        </thead>
                        <tbody id="batchTableBody" class="text-slate-600 font-medium"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Dashboard Area -->
        <div id="dashboard" class="hidden grid grid-cols-1 xl:grid-cols-4 gap-6 pb-20 fade-in">
            
            <!-- Left Column: Chart (3/4 width) -->
            <div class="xl:col-span-3 space-y-6">
                <!-- Main Chart -->
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 h-[700px] relative">
                    <div class="absolute top-4 left-4 text-xs font-mono text-slate-300 pointer-events-none">WEINSTEIN PRO SYSTEM</div>
                    <div id="mainChart" class="w-full h-full"></div>
                </div>
                
                <!-- Strategy Box (Restored v3.5 Dark Style) -->
                <div class="bg-slate-800 text-white p-6 rounded-2xl shadow-lg border border-slate-700">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2 text-blue-400">
                        <i class="fa-solid fa-shield-halved"></i>
                        <span>é¢¨éšªæ§åˆ¶èˆ‡åœæå»ºè­° (Stop-Loss Strategy)</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div>
                            <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">åˆå§‹åœæ (Initial Stop)</h4>
                            <div class="text-3xl font-black text-white" id="val-support">--</div>
                            <p class="text-xs text-slate-400 mt-1">è¨­å®šæ–¼è¿‘æœŸæ”¯æ’æˆ–ç›¤æ•´å€ä½é»ã€‚</p>
                        </div>
                        <div>
                            <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">ç§»å‹•åœæ (Trailing Stop)</h4>
                            <div class="text-3xl font-black text-yellow-400" id="val-stoploss">--</div>
                            <p class="text-xs text-slate-400 mt-1">è¨­å®šæ–¼æœ€è¿‘ä¸€æ¬¡å›èª¿ä½é» (Swing Low)ã€‚</p>
                        </div>
                        <div>
                             <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">å£“åŠ›é è­¦ (Resistance)</h4>
                             <div class="text-3xl font-black text-red-400" id="val-resist">--</div>
                             <p class="text-xs text-slate-400 mt-1">ä¸Šæ–¹æ½›åœ¨å£“åŠ›ä½ç½®ã€‚</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Analysis (1/4 width) -->
            <div class="space-y-6">
                
                <!-- Radar Chart Card (Layout Fixed) -->
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex flex-col items-center justify-center min-h-[320px]">
                    <h3 class="text-sm font-bold text-slate-500 uppercase mb-2 text-center w-full">å¤šç©ºé«”è³ªé›·é”</h3>
                    <!-- Radar Container with strict dimensions -->
                    <div class="w-full flex-grow flex items-center justify-center relative" style="height: 240px;">
                        <div id="radarChart" class="w-full h-full"></div>
                    </div>
                    <div class="text-center mt-2 w-full pt-2 border-t border-slate-100">
                        <span id="totalScore" class="text-2xl font-black text-slate-800">--</span>
                        <span class="text-xs text-slate-400 block">å¤šæ–¹ç¸½åˆ† (Max 100)</span>
                    </div>
                </div>

                <!-- Stage Analysis Card -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border-l-8 border-slate-200" id="stageCard">
                    <div class="text-xs font-bold text-slate-400 uppercase mb-1">ç›®å‰éšæ®µ (Stage Analysis)</div>
                    <div class="text-2xl font-black text-slate-800 mb-2" id="stageTitle">--</div>
                    <p class="text-sm text-slate-600 leading-relaxed" id="stageDesc">--</p>
                </div>

                <!-- Price Action Card -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2 border-b pb-3">
                        <i class="fa-solid fa-magnifying-glass-chart text-purple-600"></i>
                        <span>K ç·šå‹æ…‹åµæ¸¬ (Price Action)</span>
                    </h3>
                    <div id="priceActionContent" class="space-y-3">
                        <!-- Dynamic Content -->
                    </div>
                </div>

                <!-- Checklist -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2 border-b pb-3">
                        <i class="fa-solid fa-list-check text-blue-600"></i>
                        <span>å²ä¸¹çš„èª¡å¾‹æª¢æŸ¥è¡¨</span>
                    </h3>
                    <div class="space-y-4" id="checklistContainer">
                        <!-- Dynamic Items -->
                    </div>
                </div>

                <!-- Market Stats -->
                <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                    <h3 class="font-bold text-slate-600 mb-3 text-sm uppercase">é—œéµæ•¸æ“š</h3>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-slate-500">æœ€æ–°æ”¶ç›¤</span>
                            <span class="font-mono font-bold" id="data-close">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-500" id="label-ma">30MA ä½ç½®</span>
                            <span class="font-mono font-bold" id="data-ma">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-500">ä¹–é›¢ç‡ (Bias)</span>
                            <span class="font-mono font-bold" id="data-bias">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-500">Mansfield RS</span>
                            <span class="font-mono font-bold" id="data-rs">--</span>
                        </div>
                         <div class="flex justify-between">
                            <span class="text-slate-500">è·52é€±é«˜é»</span>
                            <span class="font-mono font-bold" id="data-high-dist">--</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- Configuration & State ---
        let config = {
            timeframe: 'W', // D, W, M
            maLength: 30,   // 20, 30, 60
            maType: 'WMA',  // Weighted MA preference
            marketType: 'US'
        };
        let currentTicker = '';
        
        // --- Utilities ---
        const sleep = ms => new Promise(r => setTimeout(r, ms));
        
        async function fetchWithTimeout(url, opts={}) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), opts.timeout || 8000);
            try {
                const res = await fetch(url, { ...opts, signal: controller.signal });
                clearTimeout(id);
                return res;
            } catch (e) {
                clearTimeout(id);
                throw e;
            }
        }

        // --- UI Interactions ---
        function setTimeframe(tf) {
            config.timeframe = tf;
            ['D','W','M'].forEach(t => {
                const el = document.getElementById(`tf-${t}`);
                if(t === tf) el.className = "flex-1 h-full rounded-lg text-xs font-bold bg-white text-blue-600 shadow-sm border border-slate-200 transition-all";
                else el.className = "flex-1 h-full rounded-lg text-xs font-bold text-slate-500 hover:bg-white transition-all";
            });
            if(currentTicker) runAnalysis();
        }

        function setMA(len) {
            config.maLength = len;
            [20,30,60].forEach(l => {
                const el = document.getElementById(`ma-${l}`);
                if(l === len) el.className = "flex-1 h-full rounded-lg text-xs font-bold bg-white text-blue-600 shadow-sm border border-slate-200 transition-all";
                else el.className = "flex-1 h-full rounded-lg text-xs font-bold text-slate-500 hover:bg-white transition-all";
            });
            if(currentTicker) runAnalysis();
        }

        function toggleScanner() {
            const panel = document.getElementById('scannerPanel');
            if(panel.classList.contains('hidden')) panel.classList.remove('hidden');
            else panel.classList.add('hidden');
        }

        function showLoading(show) {
            const el = document.getElementById('fetchProgress');
            if(show) el.classList.remove('hidden'); else el.classList.add('hidden');
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            document.getElementById('errorText').innerText = msg;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }

        // --- Core Analysis Logic ---
        async function runAnalysis() {
            const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
            const maTypeSelect = document.getElementById('maType').value;
            config.maType = maTypeSelect; 
            
            if(!ticker) return;
            currentTicker = ticker;
            
            showLoading(true);
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('analyzeBtn').disabled = true;

            try {
                const isTW = /^[0-9]{3,4}$/.test(ticker);
                config.marketType = isTW ? 'TW' : 'US';

                const stockData = await fetchData(ticker, config.marketType);
                if(!stockData || stockData.length < 60) throw new Error("è³‡æ–™ä¸è¶³");

                const indexTicker = document.getElementById('indexInput').value;
                let indexData = [];
                try { indexData = await fetchYahooData(indexTicker, true); } catch(e){ console.warn("Index fail"); }

                const rStock = resampleData(stockData, config.timeframe);
                const rIndex = resampleData(indexData, config.timeframe);

                const analyzed = calcIndicators(rStock, rIndex);
                const srLevels = calcSupportResistance(analyzed);
                const radarScore = calcRadarScore(analyzed);

                renderMainChart(ticker, analyzed, srLevels);
                renderRadar(radarScore);
                renderSidebar(analyzed, srLevels); 
                updateStats(analyzed, srLevels, radarScore);
                
                document.getElementById('dashboard').classList.remove('hidden');
                
            } catch (e) {
                showError(e.message);
            } finally {
                showLoading(false);
                document.getElementById('analyzeBtn').disabled = false;
            }
        }

        // --- Batch Scanner Logic ---
        async function runBatchAnalysis() {
            const input = document.getElementById('batchInput').value;
            const tickers = input.split(/[, \n]+/).filter(t => t.trim() !== '').map(t=>t.toUpperCase());
            if(tickers.length === 0) return alert("è«‹è¼¸å…¥ä»£ç¢¼");

            const tbody = document.getElementById('batchTableBody');
            tbody.innerHTML = '';
            document.getElementById('batchResults').classList.remove('hidden');
            document.getElementById('batchBtn').disabled = true;
            document.getElementById('batchBtn').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> æƒæä¸­...';

            let results = [];

            for(const ticker of tickers) {
                try {
                    const isTW = /^[0-9]{3,4}$/.test(ticker);
                    const rawData = await fetchData(ticker, isTW?'TW':'US', true); // Simple fetch
                    if(rawData && rawData.length > 50) {
                        const rData = resampleData(rawData, config.timeframe);
                        const analyzed = calcIndicators(rData, []); 
                        const scoreData = calcRadarScore(analyzed);
                        const last = analyzed[analyzed.length-1];
                        
                        results.push({
                            ticker,
                            price: last.close,
                            maDir: last.ma > analyzed[analyzed.length-2].ma ? 'Up' : 'Down',
                            pricePos: last.close > last.ma ? 'Above' : 'Below',
                            rs: last.mansfieldRs || 0,
                            score: scoreData.total
                        });
                    }
                } catch(e) { console.warn(`Skip ${ticker}`); }
                await sleep(500); 
            }

            results.sort((a,b) => b.score - a.score);

            results.forEach(r => {
                let badgeClass = r.score >= 80 ? 'bg-green-100 text-green-700' : (r.score < 40 ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700');
                let rank = r.score >= 80 ? 'å¼·å‹¢ (Strong)' : (r.score < 40 ? 'å¼±å‹¢ (Weak)' : 'ç›¤æ•´ (Neutral)');
                
                const row = `
                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition-colors cursor-pointer" onclick="document.getElementById('tickerInput').value='${r.ticker}'; runAnalysis();">
                        <td class="px-4 py-3 font-bold font-mono text-slate-800">${r.ticker}</td>
                        <td class="px-4 py-3 font-mono">${r.price}</td>
                        <td class="px-4 py-3 text-xs">
                            <span class="${r.pricePos==='Above'?'text-green-600':'text-red-500'} font-bold">${r.pricePos} MA</span> / 
                            <span class="${r.maDir==='Up'?'text-green-600':'text-red-500'}">${r.maDir}</span>
                        </td>
                        <td class="px-4 py-3 font-mono text-xs">${r.rs ? r.rs.toFixed(2) : '-'}</td>
                        <td class="px-4 py-3 font-bold">${r.score}</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs font-bold ${badgeClass}">${rank}</span></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            document.getElementById('batchBtn').disabled = false;
            document.getElementById('batchBtn').innerHTML = '<i class="fa-solid fa-play"></i> é–‹å§‹æƒææ’å';
        }

        // --- Data Fetching Implementations ---
        async function fetchData(ticker, type, quickMode=false) {
            if(type === 'US') return await fetchYahooData(ticker);
            return await fetchOfficialTWData(ticker, quickMode ? 12 : (config.timeframe==='M'?60:18)); 
        }
        
        async function fetchYahooData(ticker, isIndex=false) {
            const proxy = "https://corsproxy.io/?";
            const url = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?range=5y&interval=1d`;
            const res = await fetchWithTimeout(proxy + encodeURIComponent(url), {timeout: isIndex?4000:8000});
            const json = await res.json();
            const r = json.chart.result[0];
            return r.timestamp.map((t,i) => ({
                date: new Date(t*1000),
                open: r.indicators.quote[0].open[i], high: r.indicators.quote[0].high[i], 
                low: r.indicators.quote[0].low[i], close: r.indicators.quote[0].close[i], 
                volume: r.indicators.quote[0].volume[i]
            })).filter(d=>d.close);
        }

        async function fetchOfficialTWData(ticker, months) {
            let data = [];
            const now = new Date();
            const proxy = "https://corsproxy.io/?";
            
            for(let i=0; i<months; i++) {
                const d = new Date(); d.setMonth(d.getMonth()-i); d.setDate(1);
                const q = d.toISOString().split('T')[0].replace(/-/g, '');
                // Try TWSE
                try {
                    let u = `https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&date=${q}&stockNo=${ticker}`;
                    let res = await fetch(proxy + encodeURIComponent(u));
                    let j = await res.json();
                    if(j.stat==='OK') {
                        data = j.data.map(r => ({
                            date: new Date(`${parseInt(r[0].split('/')[0])+1911}-${r[0].split('/')[1]}-${r[0].split('/')[2]}`),
                            open: parseFloat(r[3].replace(/,/g,'')), high: parseFloat(r[4].replace(/,/g,'')),
                            low: parseFloat(r[5].replace(/,/g,'')), close: parseFloat(r[6].replace(/,/g,'')),
                            volume: parseFloat(r[8].replace(/,/g,''))
                        })).concat(data);
                        continue; 
                    }
                } catch(e){}
                // Try TPEX
                try {
                    let y = d.getFullYear()-1911; let m = (d.getMonth()+1).toString().padStart(2,'0');
                    let u = `https://www.tpex.org.tw/web/stock/aftertrading/daily_trading_info/st43_result.php?l=zh-tw&d=${y}/${m}/01&stkno=${ticker}`;
                    let res = await fetch(proxy + encodeURIComponent(u));
                    let j = await res.json();
                    if(j.aaData) {
                        data = j.aaData.map(r => ({
                            date: new Date(`${parseInt(r[0].split('/')[0])+1911}-${r[0].split('/')[1]}-${r[0].split('/')[2]}`),
                            open: parseFloat(r[3].replace(/,/g,'')), high: parseFloat(r[4].replace(/,/g,'')),
                            low: parseFloat(r[5].replace(/,/g,'')), close: parseFloat(r[6].replace(/,/g,'')),
                            volume: parseFloat(r[1].replace(/,/g,''))*1000
                        })).concat(data);
                    }
                } catch(e){}
                await sleep(200);
            }
            return data.sort((a,b)=>a.date-b.date).filter(x=>!isNaN(x.close));
        }

        function resampleData(data, tf) {
            if(!data || data.length===0) return [];
            if(tf==='D') return data;
            const map = {};
            data.forEach(d => {
                let k;
                if(tf==='W') {
                    let dt = new Date(d.date);
                    let day = dt.getDay();
                    let diff = 5 - day; 
                    dt.setDate(dt.getDate() + (diff>=0?diff:diff+7));
                    k = dt.toISOString().split('T')[0];
                } else {
                    k = `${d.date.getFullYear()}-${d.date.getMonth()+1}`;
                }
                if(!map[k]) map[k] = { date: new Date(k), open: d.open, high: d.high, low: d.low, close: d.close, volume: 0 };
                map[k].high = Math.max(map[k].high, d.high);
                map[k].low = Math.min(map[k].low, d.low);
                map[k].close = d.close;
                map[k].volume += d.volume;
            });
            return Object.values(map).sort((a,b)=>a.date-b.date);
        }

        // --- Indicator Calculation ---
        function calcIndicators(data, idxData) {
            const period = config.maLength;
            const rsPeriod = 52;
            const weights = Array.from({length:period},(_,i)=>i+1);
            const wSum = weights.reduce((a,b)=>a+b,0);
            
            const iMap = {};
            idxData.forEach(d=> iMap[d.date.toISOString().split('T')[0]] = d.close);

            for(let i=0; i<data.length; i++) {
                // MA
                if(i >= period-1) {
                    if(config.maType === 'WMA') {
                        let s = 0;
                        for(let j=0; j<period; j++) s += data[i-(period-1)+j].close * weights[j];
                        data[i].ma = s/wSum;
                    } else {
                        let s = 0;
                        for(let j=0; j<period; j++) s += data[i-j].close;
                        data[i].ma = s/period;
                    }
                } else data[i].ma = null;

                // Vol MA
                if(i>=4) {
                    let vs = 0; for(let j=0; j<5; j++) vs += data[i-j].volume;
                    data[i].volMa = vs/5;
                }

                // RS (Ratio)
                const dKey = data[i].date.toISOString().split('T')[0];
                let iClose = iMap[dKey]; 
                if(!iClose && idxData.length) {
                    const match = idxData.find(x => Math.abs(x.date-data[i].date) < 300000000); 
                    if(match) iClose = match.close;
                }
                data[i].rsRatio = iClose ? data[i].close/iClose : null;
            }

            // RS MA & Mansfield
            const rsRatios = data.map(d=>d.rsRatio);
            for(let i=0; i<data.length; i++) {
                if(i >= rsPeriod-1 && data[i].rsRatio) {
                    let s=0, c=0;
                    for(let j=0; j<rsPeriod; j++) {
                        if(rsRatios[i-j]) { s+=rsRatios[i-j]; c++; }
                    }
                    const smaRS = c>0 ? s/c : null;
                    data[i].rsMa = smaRS; // Save for Line Chart (Classic RS)
                    data[i].mansfieldRs = smaRS ? ((data[i].rsRatio/smaRS)-1) : null;
                } else {
                    data[i].rsMa = null;
                    data[i].mansfieldRs = null;
                }
            }
            
            // 52-week High
            for(let i=0; i<data.length; i++) {
                 if(i >= 52) {
                    let max = 0;
                    for(let j=0; j<52; j++) max = Math.max(max, data[i-j].high);
                    data[i].high52 = max;
                } else data[i].high52 = data[i].high;
            }

            return data.filter(d => d.ma !== null);
        }

        function calcSupportResistance(data) {
            const window = 20; 
            const levels = [];
            for(let i=window; i<data.length-window; i++) {
                const curr = data[i];
                let isHigh = true;
                for(let j=1; j<=window; j++) {
                    if(data[i-j].high > curr.high || data[i+j].high > curr.high) isHigh = false;
                }
                if(isHigh) levels.push({price: curr.high, type: 'R'});

                let isLow = true;
                for(let j=1; j<=window; j++) {
                    if(data[i-j].low < curr.low || data[i+j].low < curr.low) isLow = false;
                }
                if(isLow) levels.push({price: curr.low, type: 'S'});
            }
            const curPrice = data[data.length-1].close;
            const resist = levels.filter(l=>l.type==='R' && l.price > curPrice).sort((a,b)=>a.price-b.price)[0];
            const support = levels.filter(l=>l.type==='S' && l.price < curPrice).sort((a,b)=>b.price-a.price)[0];
            
            return {
                resist: resist ? resist.price : null,
                support: support ? support.price : null,
                stopLoss: support ? support.price : data[data.length-1].ma
            };
        }

        function calcRadarScore(data) {
            const last = data[data.length-1];
            const prev = data[data.length-2];
            
            // 1. Trend (30%)
            let sTrend = 0;
            if(last.close > last.ma) sTrend += 15;
            if(last.ma > prev.ma) sTrend += 15;

            // 2. Momentum (Bias) (20%)
            let sMom = 0;
            const bias = (last.close - last.ma) / last.ma;
            if(bias > 0 && bias < 0.15) sMom = 20; 
            else if(bias >= 0.15) sMom = 10; 
            else if(bias < 0) sMom = 0;

            // 3. Volume (20%)
            let sVol = 0;
            if(last.volume > last.volMa) sVol = 20;
            else if(last.volume > last.volMa * 0.8) sVol = 10;

            // 4. Strength (RS) (30%)
            let sRS = 0;
            if(last.mansfieldRs > 0) sRS += 15;
            if(last.mansfieldRs > prev.mansfieldRs) sRS += 15;

            return {
                trend: sTrend,
                momentum: sMom,
                volume: sVol,
                strength: sRS,
                total: sTrend + sMom + sVol + sRS
            };
        }

        // --- Rendering ---
        function renderMainChart(ticker, data, sr) {
            const dates = data.map(d=>d.date);
            const candles = {
                x: dates, close: data.map(d=>d.close), high: data.map(d=>d.high), low: data.map(d=>d.low), open: data.map(d=>d.open),
                type: 'candlestick', name: 'Price', yaxis: 'y'
            };
            const maLine = {
                x: dates, y: data.map(d=>d.ma), type: 'scatter', mode: 'lines', name: `${config.maLength}${config.maType}`,
                line: { color: 'blue', width: 2 }
            };
            const volBar = {
                x: dates, y: data.map(d=>d.volume), type: 'bar', name: 'Vol', yaxis: 'y2',
                marker: { color: data.map(d => d.close >= d.open ? '#22c55e' : '#ef4444') }
            };
            
            // Restored RS Lines (instead of Mansfield bars)
            const traces = [candles, maLine, volBar];
            if(data[0].rsRatio !== null) {
                const traceRS = {
                    x: dates, y: data.map(d=>d.rsRatio), type: 'scatter', mode: 'lines', name: 'RS ç·š', yaxis: 'y3',
                    line: { color: '#0ea5e9', width: 1.5 }
                };
                const traceRSMa = {
                    x: dates, y: data.map(d=>d.rsMa), type: 'scatter', mode: 'lines', name: 'RS å‡ç·š (52)', yaxis: 'y3',
                    line: { color: '#ec4899', width: 1, dash: 'dot' }
                };
                traces.push(traceRS);
                traces.push(traceRSMa);
            }

            const shapes = [];
            if(sr.resist) shapes.push({ type: 'line', x0: dates[0], x1: dates[dates.length-1], y0: sr.resist, y1: sr.resist, line: {color:'red', width:1, dash:'dash'} });
            if(sr.support) shapes.push({ type: 'line', x0: dates[0], x1: dates[dates.length-1], y0: sr.support, y1: sr.support, line: {color:'green', width:1, dash:'dash'} });

            const annotations = [];
            data.forEach((d, i) => {
                if(i > 0 && d.volume > d.volMa * 2) { 
                    annotations.push({
                        x: d.date, y: d.high, yref: 'y',
                        text: 'ğŸ’¥', showarrow: false, yanchor: 'bottom'
                    });
                }
            });

            const layout = {
                grid: { rows: 3, columns: 1, roworder: 'top to bottom', heights: [0.6, 0.2, 0.2] },
                xaxis: { type: 'date', rangeslider: {visible:false}, anchor: 'y3' },
                yaxis: { title: 'Price', domain: [0.45, 1] },
                yaxis2: { title: 'Vol', domain: [0.25, 0.40] },
                yaxis3: { title: 'RS å¼·åº¦', domain: [0, 0.20] },
                height: 700, margin: {t:20,b:40,l:50,r:20}, showlegend: false,
                shapes: shapes, annotations: annotations,
                hovermode: 'x unified'
            };

            Plotly.newPlot('mainChart', traces, layout, {responsive:true});
        }

        function renderRadar(score) {
            const data = [{
                type: 'scatterpolar',
                r: [score.trend/30*100, score.momentum/20*100, score.volume/20*100, score.strength/30*100, score.trend/30*100],
                theta: ['è¶¨å‹¢ Trend','å‹•èƒ½ Mom','é‡èƒ½ Vol','å¼·åº¦ RS', 'è¶¨å‹¢ Trend'],
                fill: 'toself',
                line: { color: '#4f46e5' }
            }];
            const layout = {
                polar: {
                    radialaxis: { visible: true, range: [0, 100], tickfont: {size: 10} }
                },
                margin: {t:30, b:30, l:50, r:50}, // Optimized margins
                height: 240, // Match container
                showlegend: false
            };
            Plotly.newPlot('radarChart', data, layout, {responsive:true});
        }

        function renderSidebar(data, sr) {
            const last = data[data.length-1];
            const prev = data[data.length-2];
            
            const isAbove = last.close > last.ma;
            const isRising = last.ma > prev.ma;
            const stageBox = document.getElementById('stageCard');
            const stageTitle = document.getElementById('stageTitle');
            const stageDesc = document.getElementById('stageDesc');
            
            if(isAbove && isRising) {
                stageTitle.innerText = "ç¬¬äºŒéšæ®µ (å¤šé ­è¶¨å‹¢)";
                stageDesc.innerText = "è‚¡åƒ¹ä½æ–¼å‡ç·šä¹‹ä¸Šï¼Œä¸”å‡ç·šæ­£åœ¨ä¸Šæšã€‚é€™æ˜¯å²ä¸¹ï¼æº«æ–¯å¦å®šç¾©çš„ã€Œæœ€ä½³è²·é€²/æŒæœ‰ã€éšæ®µã€‚";
                stageBox.style.borderLeftColor = "#16a34a"; 
            } else if (!isAbove && !isRising) {
                stageTitle.innerText = "ç¬¬å››éšæ®µ (ç©ºé ­è¶¨å‹¢)";
                stageDesc.innerText = "è‚¡åƒ¹è·Œç ´å‡ç·šï¼Œä¸”å‡ç·šä¸‹å½ã€‚é¢¨éšªæ¥µå¤§ï¼Œå»ºè­°ã€Œè³£å‡ºã€æˆ–ã€Œæ”¾ç©ºã€ã€‚";
                stageBox.style.borderLeftColor = "#dc2626"; 
            } else if (isAbove && !isRising) {
                stageTitle.innerText = "ç¬¬ä¸€éšæ®µ (æ‰“åº•å€åŸŸ)";
                stageDesc.innerText = "è‚¡åƒ¹é›–ç«™ä¸Šå‡ç·šï¼Œä½†å‡ç·šå°šæœªç¿»æšã€‚é€šå¸¸æ˜¯ç›¤æ•´æœŸï¼Œå»ºè­°è§€æœ›ç­‰å¾…çªç ´ã€‚";
                stageBox.style.borderLeftColor = "#2563eb"; 
            } else {
                stageTitle.innerText = "ç¬¬ä¸‰éšæ®µ (é ­éƒ¨éœ‡ç›ª)";
                stageDesc.innerText = "è‚¡åƒ¹æ³¢å‹•åŠ åŠ‡ï¼Œå‡ç·šèµ°å¹³æˆ–è‚¡åƒ¹è·Œç ´å‡ç·šã€‚æ‡‰è€ƒæ…®ç²åˆ©äº†çµã€‚";
                stageBox.style.borderLeftColor = "#ca8a04"; 
            }
            
            const paContainer = document.getElementById('priceActionContent');
            paContainer.innerHTML = '';
            let paCount = 0;
            const addPA = (title, desc, colorClass) => {
                paCount++;
                paContainer.innerHTML += `
                    <div class="flex items-center gap-2 text-sm">
                        <span class="px-2 py-1 rounded text-xs font-bold ${colorClass}">${title}</span>
                        <span class="text-slate-600">${desc}</span>
                    </div>`;
            };

            if(last.close > last.ma && prev.close < prev.ma && last.volume > last.volMa * 1.5) {
                addPA("é—œéµçªç ´", "å¸¶é‡ç«™ä¸Š MAï¼Œæ½›åœ¨è²·é»", "bg-green-100 text-green-700");
            }
            if(last.close > last.open && prev.close < prev.open && last.close > prev.open && last.open < prev.close) {
                addPA("å¤šé ­åå™¬", "å¼·å‹¢åè½‰è¨Šè™Ÿ", "bg-green-100 text-green-700");
            }
            if(last.close < last.open && prev.close > prev.open && last.close < prev.open && last.open > prev.close) {
                addPA("ç©ºé ­åå™¬", "é ‚éƒ¨åè½‰é¢¨éšª", "bg-red-100 text-red-700");
            }
            if(last.high < prev.high && last.low > prev.low) {
                addPA("å­•ç·šç›¤æ•´", "å¤šç©ºä¸æ˜ï¼Œç­‰å¾…æ–¹å‘", "bg-yellow-100 text-yellow-700");
            }
            if(Math.min(last.close, last.open) - last.low > Math.abs(last.close - last.open) * 2) {
                addPA("éŒ˜é ­/æ¢åº•", "ä¸‹æ–¹æœ‰æ”¯æ’", "bg-blue-100 text-blue-700");
            }
            if(paCount === 0) {
                paContainer.innerHTML = '<span class="text-xs text-slate-400">ç›®å‰ç„¡ç‰¹æ®Š K ç·šå‹æ…‹</span>';
            }

            const checklist = document.getElementById('checklistContainer');
            checklist.innerHTML = '';
            
            const addItem = (label, pass, value) => {
                const icon = pass ? '<i class="fa-solid fa-circle-check check-pass"></i>' : '<i class="fa-solid fa-circle-xmark check-fail"></i>';
                checklist.innerHTML += `
                    <div class="flex items-start gap-3 p-3 bg-slate-50 rounded-lg">
                        <div class="mt-1 text-lg">${icon}</div>
                        <div>
                            <div class="font-bold text-sm text-slate-700">${label}</div>
                            <div class="text-xs ${pass ? 'text-green-600' : 'text-red-500'} font-mono mt-1">
                                ${pass ? 'PASS' : 'FAIL'}: ${value}
                            </div>
                        </div>
                    </div>`;
            };

            addItem(`å‡ç·šä½ç½® (Price > ${config.maLength}MA)`, isAbove, `æ”¶ç›¤ ${last.close} / MA ${last.ma.toFixed(2)}`);
            const maSlope = last.ma - prev.ma;
            addItem("å‡ç·šæ–¹å‘ (MA Rising)", isRising, `æ–œç‡ ${maSlope.toFixed(4)}`);
            const volSpike = last.volume > (last.volMa * 1.5);
            addItem("æˆäº¤é‡ç¢ºèª (Volume)", volSpike || isAbove, volSpike ? "çˆ†é‡ (å¤§æ–¼å‡é‡1.5å€)" : (isAbove ? "é‡èƒ½æº«å’Œ" : "é‡ç¸®"));
            const distHigh = ((last.high52 - last.close) / last.close) * 100;
            const isBlueSky = distHigh < 2;
            addItem("é˜»åŠ›æœ€å°ä¹‹è·¯ (Resistance)", isBlueSky, isBlueSky ? "çªç ´æ–°é«˜" : `è·52é€±é«˜é» ${distHigh.toFixed(1)}%`);

            const hasRS = last.mansfieldRs !== null;
            if (hasRS) {
                const isStrongRS = last.mansfieldRs > 0;
                addItem("æ›¼æ–¯è²çˆ¾å¾· RS (Zero Line)", isStrongRS, isStrongRS ? `æ­£å€¼ (+${last.mansfieldRs.toFixed(2)})` : `è² å€¼ (${last.mansfieldRs.toFixed(2)})`);
            } else {
                 checklist.innerHTML += `<div class="p-3 bg-slate-50 rounded-lg text-xs text-slate-400">RS è³‡æ–™ä¸è¶³ï¼Œç„¡æ³•åˆ¤æ–·</div>`;
            }
        }

        function updateStats(data, sr, score) {
            const last = data[data.length-1];
            
            document.getElementById('val-support').innerText = sr.support ? sr.support.toFixed(2) : '-';
            document.getElementById('val-resist').innerText = sr.resist ? sr.resist.toFixed(2) : '-';
            document.getElementById('val-stoploss').innerText = sr.stopLoss.toFixed(2);
            document.getElementById('totalScore').innerText = score.total;
            
            document.getElementById('data-close').innerText = last.close;
            document.getElementById('label-ma').innerText = `${config.maLength}MA ä½ç½®`;
            document.getElementById('data-ma').innerText = last.ma.toFixed(2);
            document.getElementById('data-bias').innerText = (((last.close - last.ma)/last.ma)*100).toFixed(2) + "%";
            document.getElementById('data-rs').innerText = last.mansfieldRs ? last.mansfieldRs.toFixed(2) : '-';
            
            const distHigh = ((last.high52 - last.close) / last.close) * 100;
            document.getElementById('data-high-dist').innerText = last.high52 ? "-" + distHigh.toFixed(1) + "%" : "-";
        }
    </script>
</body>
</html>
